<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Refeitório</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
    <h1>Controle de Refeitório</h1>
    <div id="reader" style="width:300px;"></div>
    <p id="result" style="font-size: 1.5em; color: green; font-weight: bold;"></p>

    <!-- Botão para baixar dados -->
    <button onclick="exportData()">Exportar Registros</button>

    <!-- Adicionando o som -->
    <audio id="success-sound" src="success.mp3" preload="auto"></audio>

    <script>
        // Array para armazenar os registros de leitura
        const registros = [];

        const reader = new Html5Qrcode("reader");

        // Inicia o leitor QR Code
        reader.start(
            { facingMode: "user" }, // Câmera frontal
            {
                fps: 10, // Frames por segundo
                qrbox: 250 // Tamanho da área de leitura
            },
            (decodedText) => {
                // Simulação de extração de dados do QR Code
                try {
                    const data = JSON.parse(decodedText); // Converte string JSON para objeto
                    const registro = {
                        id: data.id || "Desconhecido",
                        nome: data.name || "Desconhecido",
                        data: new Date().toLocaleDateString(),
                        horario: new Date().toLocaleTimeString(),
                        status: "Confirmado"
                    };

                    // Verifica duplicidade (exemplo simples)
                    if (registros.find(r => r.id === registro.id && r.data === registro.data)) {
                        document.getElementById("result").innerText = `${registro.nome} já registrado hoje.`;
                    } else {
                        registros.push(registro);

                        // Exibe mensagem de sucesso
                        document.getElementById("result").innerText = `${registro.nome} registrado com sucesso!`;

                        // Toca som de sucesso
                        const successSound = document.getElementById("success-sound");
                        successSound.play();
                    }

                    // Limpa a mensagem após 3 segundos
                    setTimeout(() => {
                        document.getElementById("result").innerText = "";
                    }, 3000);

                } catch (e) {
                    console.error("Erro ao processar QR Code:", e);
                    document.getElementById("result").innerText = "Erro ao processar QR Code!";
                }
            },
            (errorMessage) => {
                console.error(errorMessage); // Exibe mensagens de erro no console
            }
        );

        // Função para exportar os dados como CSV
        function exportData() {
            if (registros.length === 0) {
                alert("Nenhum registro para exportar!");
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8,"
                + "ID,Nome,Data,Horário,Status\n"
                + registros.map(r => `${r.id},${r.nome},${r.data},${r.horario},${r.status}`).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "registros_refeitorio.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
